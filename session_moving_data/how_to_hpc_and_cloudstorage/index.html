
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>How to move data between the MSU HPC and Azure - MSU Cloud Fellowship</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-move-data-between-the-msu-hpc-and-azure" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MSU Cloud Fellowship" class="md-header__button md-logo" aria-label="MSU Cloud Fellowship" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MSU Cloud Fellowship
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to move data between the MSU HPC and Azure
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MSU Cloud Fellowship" class="md-nav__button md-logo" aria-label="MSU Cloud Fellowship" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    MSU Cloud Fellowship
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        Contact
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Sessions
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Sessions" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Sessions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_introduction/" class="md-nav__link">
        1. Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_how_to_cloud/" class="md-nav__link">
        2. How does the cloud work?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_cloud_storage/" class="md-nav__link">
        3. Cloud Storage
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        4. Moving Data
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_bigdata/" class="md-nav__link">
        5. Big Data and the cloud
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_datasystems/" class="md-nav__link">
        6. Cloud Data Systems
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../session_serverless/" class="md-nav__link">
        7. Serverless, Containers, and FaaS
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cloud_glossary/" class="md-nav__link">
        Cloud Glossary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-1-using-scp-with-a-virtual-machine" class="md-nav__link">
    Method 1. using scp with a virtual machine
  </a>
  
    <nav class="md-nav" aria-label="Method 1. using scp with a virtual machine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-little-about-the-scp-utility" class="md-nav__link">
    A little about the scp utility
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-2-azcopy" class="md-nav__link">
    Method 2. azcopy
  </a>
  
    <nav class="md-nav" aria-label="Method 2. azcopy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements_1" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternative-methods" class="md-nav__link">
    Alternative Methods
  </a>
  
    <nav class="md-nav" aria-label="Alternative Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-3-azure-data-factory" class="md-nav__link">
    Method 3. Azure data factory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-4-python" class="md-nav__link">
    Method 4. Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-5-python-with-url" class="md-nav__link">
    Method 5. Python with URL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="how-to-move-data-between-the-msu-hpc-and-azure">How to move data between the MSU HPC and Azure</h1>
<h2 id="introduction">Introduction</h2>
<p>A common research cloud computing activity is moving data between cloud and on-premise (local) systems.   Many universities provide great local systems at low costs, and some research groups have existing systems they've invested in, whereas cloud computing is an on-going costs. </p>
<p>Azure has a rich data ecosystem and there are many methods to copy data from our local research cluster ([MSU ICER HPCC) to Azure Storage.  The follow are examples of methods that I've used, and all assume you are moving data to "Azure Blob" storage but may require minor adjustment to use "Azure Files" storage which should also work.  I don't discuss "queue" or "table" storage at all and that my require other services to use (events or data factory)  </p>
<h2 id="method-1-using-scp-with-a-virtual-machine">Method 1. using scp with a virtual machine</h2>
<p>Sometimes you don't need a durable storage account at all, you just need to get some data onto the virtual machine you are using for computation.  This method is useful for one-time workflow of copy, process, save results.   </p>
<h3 id="requirements">Requirements</h3>
<ul>
<li>an account on the MSU HPCC</li>
<li>basic knowledge of Linux</li>
<li>know how to create and use a Azure Virtual Machine</li>
</ul>
<h3 id="a-little-about-the-scp-utility">A little about the <code>scp</code> utility</h3>
<p>The HPC runs Linux, and The <code>cp</code> utility copies files from one folder to another.   The <code>scp</code> utility allows us to do that across the network, using a secure method, providing you have an account on the remote system and <code>ssh</code> access.   There are many programs to help with network file transfers but <code>rsync</code> and <code>rclone</code> are two command (and really great) programs to checkout.  We will stick with <code>scp</code> for this example </p>
<p>The basic format of the scp command is <code>scp user@remote.system.com:path/to/remote/file path/to/copy_of_file</code></p>
<p>For examples see <a href="http://www.hypexr.org/linux_scp_help.php">http://www.hypexr.org/linux_scp_help.php</a></p>
<p>Method 1a. simple method for a one-time copy to an Azure VM: </p>
<p>Steps: 
1. find the file on the MSU HPCC that you want to copy.  Note the location and full path
1. create your Virtual Machine in Azure that you will use for your computations if it isn't already. 
    - if the file is particularly large, make sure to create a VM disk that is large enough to contain it
1. log-in to the virtual machine with the username and password you created (with remote desktop, or for Linux with ssh)
1. if you are using Windows with remote desktop, start cmd.exe to get a terminal, if on Linux, you are already on the terminal
1. use an scp command like this: 
    - first, note the folder you are running this from (it defaults to the VM home directory)
    - <code>scp mynetid@hpcc.msu.edu:path/to/file.ext file.ext</code>
    - you may be asked to accept the host 'fingerprint' if this is the first time you are using scp
    - enter your NetID password (it is not saved or visible on the command line)
    - consider using ssh keys instead of your password (which is a whole 'nother lesson)
    - see <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys</a>  </p>
<ol>
<li>Now you can access the file using the software from the
I think of this as  "pulling" data from HPC to the VM disk. </li>
</ol>
<h2 id="method-2-azcopy">Method 2. azcopy</h2>
<h3 id="requirements_1">Requirements</h3>
<ul>
<li>A Storage account.  We created one in the first session, but create a storage account in your resource group if you don't have one yet. </li>
<li>Create a container in storage account to hold files. This can be a Blob or Azure Files container</li>
<li>You must be owner of the storage account, and able to assign permissions ('roles').  Azure requires special persmissions grant that are NOT granted by default to use azcopy.  Details in the instructions below</li>
<li>OR you must be willing to go through the process of creating a "SAS Token" :  see my <a href="../creating_a_container_sas_token_from_the_azure_portal/">instructions for creating SAS token</a></li>
</ul>
<p>Assuming you have a storage account with a blob container already created.  In the portal, open the storage account container. </p>
<p>Azure provides a command line tool <code>azcopy</code> which you can download for windows, mac and Linux.   see <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10</a></p>
<p>How to install the azcopy utility </p>
<ol>
<li>Login to MSU HPCC  <code>ssh &lt;netid&gt;@hpcc.msu.edu</code></li>
<li>download a copy of azcopy.  This is the URL from Late september 2021: 
   <code>curl -O https://azcopyvnext.azureedge.net/release20210920/azcopy_linux_amd64_10.12.2.tar.gz</code></li>
<li>untar and put in your home directory
   <code>tar -xvzf azcopy_linux_amd64_10.12.2.tar.gz</code></li>
</ol>
<p>How to use azcopy to upload to Azure using the "AD Login"</p>
<ol>
<li>Get a SAS URL from the Azure portal as described above</li>
<li>Log-in to HPCC</li>
<li>assuming your copy of <code>azcopy</code> is in your home directory, run a command like the following.  Note that the URL <em>must</em> but enclosed in single quotes (not double quotes)</li>
</ol>
<p>`azcopy copy myfile.csv '<a href="https://storageaccount.blob.core.windows.net/containername/myfile.csv?SASToken">https://storageaccount.blob.core.windows.net/containername/myfile.csv?SASToken</a>'</p>
<p>For example, this copies a file and renames it when it's stored.  The container "from-hpcc" in this case must already be created.  </p>
<p><code>azcopy copy 2008.csv 'https://cf21billspatstorage.blob.core.windows.net/from-hpcc/airlinedata_2008.csv?sp=racwdl&amp;st=2021-10-08T05:22:52Z&amp;se=2021-10-08T13:22:52Z&amp;sip=35.9.12.1-35.9.12.255&amp;spr=https&amp;sv=2020-08-04&amp;sr=c&amp;sig=abscus'</code></p>
<p>References:
 - <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10">Getting Started with azcopy</a>
 - <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-ref-azcopy-login">azcopy login reference</a>
 - <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-authorize-azure-active-directory">Authorize access to blobs with AzCopy and Azure Active Directory (Azure AD)</a>
 - <a href="https://docs.microsoft.com/en-us/azure/cognitive-services/translator/document-translation/create-sas-tokens?tabs=Containers">Generate SAS tokens for your storage containers</a>  *(note I found this in the "cognitive services" documentation)</p>
<h2 id="alternative-methods">Alternative Methods</h2>
<h3 id="method-3-azure-data-factory">Method 3. Azure data factory</h3>
<p>We will cover what "Azure Data Factory" is in session 4, but this is included in this session for completeness. </p>
<p>If you have some familiarity with Azure data factory, note that a "source" for Azure Data Factory" can be an 'sftp' or 'secure file transfer protocol' which most systems that have 'ssh' (secure shell) access allow, and is simlar to using the 'scp' or 'secure copy' utility. </p>
<h3 id="method-4-python">Method 4. Python</h3>
<p>We won't really cover using Python to copy files to/from blob storage, but see the optional exercise for using Azure cloud storage in Python in <a href="../../session_cloud_storage/">session #3</a>.  </p>
<p>To use Azure python SDK on the HPC you need to installed the azure python sdk in a python environment in your home directory, for example using the Anaconda distribution of Python.  See <a href="https://wiki.hpcc.msu.edu/display/ITH/Using+conda">https://wiki.hpcc.msu.edu/display/ITH/Using+conda</a>.   </p>
<h3 id="method-5-python-with-url">Method 5. Python with URL</h3>
<p>Another approach that does not require the Azure SDK, is  URL access, the same as for <code>azcopy</code>  via the <code>requests</code> library.  For example, to download a CSV file from cloud storage, generate a SAS URL just for that file in the portal, and run this code</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">azure_url</span> <span class="o">=</span> <span class="s2">&quot;https://cf21billspatstorage.blob.core.windows.net/from-hpcc/airlinedata_2008.csv?sp=racwdl&amp;st.... etc&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># see note below*</span>
<span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_lines</span><span class="p">())</span>
  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
     <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>don't put this code into github with the SAS url.  Use a technique to read from command line or environment </li>
<li>This would work anywhere, not just the HPC.  </li>
<li>This is the same example in the slides for this session</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>